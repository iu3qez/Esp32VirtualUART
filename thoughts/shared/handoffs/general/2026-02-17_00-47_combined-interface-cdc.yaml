---
session: general
date: 2026-02-17
status: partial
outcome: PARTIAL_PLUS
---

goal: Fix 6-port CDC-ACM USB enumeration with combined-interface descriptor layout
now: Flash firmware and test on Linux (dmesg for /dev/ttyACM*), then test on Windows

test: "Flash firmware, check dmesg for 6x /dev/ttyACM* on Linux; check Device Manager on Windows"

done_this_session:
  - task: Fixed GHWCFG register dump crash (moved register reads AFTER tinyusb_driver_install enables USB peripheral clock)
    files: [components/port_cdc/port_cdc.c]
  - task: Captured and analyzed DWC2 hardware capabilities from GHWCFG registers
    files: [components/port_cdc/port_cdc.c]
  - task: Implemented combined-interface CDC descriptor layout (single interface per CDC, self-referencing Union)
    files: [components/port_cdc/usb_descriptors.c]
  - task: Created TinyUSB cdcd_open() patch for combined-interface support (transfer-type check before assuming notification EP)
    files: [tools/patch_cdc_combined.py]
  - task: Wired patch into CMake build system
    files: [CMakeLists.txt]
  - task: Decoupled frontend build from firmware build (Node.js 18 vs Vite 20+ blocker)
    files: [CMakeLists.txt, data/www/index.html]

blockers:
  - "Not yet tested on hardware — firmware builds successfully but needs flash + host verification"
  - "Frontend build still broken (Node.js 18 vs Vite requiring 20+) — decoupled but not fixed"

questions:
  - "Does Linux cdc_acm actually enter combined_interfaces path with self-referencing Union descriptor?"
  - "Does Windows usbser.sys accept single-interface CDC with bulk on comm interface?"
  - "Will macOS IOUSBFamily handle this non-standard layout?"

decisions:
  - combined_interface_layout: "Single interface per CDC port with bulk endpoints on Communication interface. CDC Union self-references (bSlaveInterface0 = bMasterInterface). Triggers Linux cdc_acm 'combined_interfaces' code path that skips notification EP requirement."
  - iad_single_interface: "Keep IAD with bInterfaceCount=1 per CDC function. Unusual but valid. Required for Windows usbccgp.sys composite device enumeration."
  - tinyusb_patch_approach: "Patch cdcd_open() to check endpoint transfer type (TUSB_XFER_INTERRUPT) before treating as notification EP. Bulk endpoints fall through to separate endpoint pair opener. Backward compatible with standard 2-interface CDC."
  - bcdDevice_bump: "Bumped bcdDevice from 0x0210 to 0x0220 to invalidate Windows/Linux descriptor cache from previous firmware."
  - frontend_decouple: "Commented out add_dependencies(littlefs_storage_bin frontend_build) and added placeholder data/www/index.html. Frontend is independent task."

findings:
  - ghwcfg_hardware_limits: "ESP32-P4 DWC2 HS: NumInEps=7 (non-zero, 8 total with EP0), DfifoDepth=896 words (3584 bytes). TinyUSB dwc2_esp32.h:76 claims ep_fifo_size=4096 — WRONG, actual is 3584."
  - ep_budget: "6 CDC bulk IN uses EP1-EP6 IN (6 of 7 non-zero). Zero spare for notification interrupt EPs. Combined interface layout is the only path to 6 ports."
  - register_access_timing: "DWC2 GHWCFG registers at 0x50000000+ cause Load Access Fault if read before USB peripheral clock enabled. Must read AFTER tinyusb_driver_install()."
  - interface_reduction: "6 interfaces (down from 12) with combined layout. ITF_NUM_TOTAL=6. CONFIG_TOTAL_LEN = 9 + 6*50 = 309 bytes."
  - linux_error_confirmed: "dmesg shows 'cdc_acm 1-4:1.0: probe with driver cdc_acm failed with error -22' on all 6 comm interfaces (1.0, 1.2, 1.4, 1.6, 1.8, 1.10). Data interfaces (1.1, 1.3, etc.) fall through to input subsystem."

worked:
  - "GHWCFG register dump (after moving post-driver-install) — confirmed hardware capabilities"
  - "Combined-interface descriptor macro compiles correctly — CONFIG_TOTAL_LEN matches"
  - "TinyUSB cdcd_open() patch applies cleanly via Python script"
  - "Full firmware builds successfully (309 KB, 76% flash free)"

failed:
  - "Original 2-interface CDC without notification EP — Linux cdc_acm returns -EINVAL (-22) on all 6 ports"
  - "GHWCFG register read before tinyusb_driver_install — Load Access Fault crash at 0x50000048"

next:
  - "Flash firmware to ESP32-P4 and capture serial log (verify GHWCFG dump + TinyUSB install)"
  - "Plug into Linux host, check dmesg for cdc_acm binding (should see combined_interfaces path)"
  - "If Linux works: test echo/cat on /dev/ttyACM0-5"
  - "Plug into Windows host, check Device Manager for COM ports"
  - "If combined interface doesn't work on Linux: check kernel version, try 'lsusb -v' to verify descriptor layout"
  - "If combined interface doesn't work on Windows: may need to add empty Data interface back (bInterfaceCount=2 in IAD)"
  - "Fix frontend build (upgrade Node.js to 20+)"
  - "Correct dwc2_esp32.h ep_fifo_size from 4096 to 3584 (optional, may affect FIFO allocation math)"

files:
  created: [tools/patch_cdc_combined.py, data/www/index.html]
  modified: [components/port_cdc/usb_descriptors.c, components/port_cdc/port_cdc.c, CMakeLists.txt]
